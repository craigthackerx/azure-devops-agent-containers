name: 'Base RHEL Build'

on:
  push:
    branches:
      - main
      - dev
      - mvp
      - feature*
  workflow_dispatch:

jobs:

  build:

    name: 'Container Base Build'
    runs-on: ubuntu-latest
    environment: main
    env:
      CONTEXT: "devops-agents/linux/rhel8/base"
      DOCKERFILE_NAME: "Base.Dockerfile"

      PYTHON3_VERSION: "3.9.10"

      IMAGE_NAME: "azure-devops-agent-base-rhel"
      TAGS: "latest"

      GITHUB_REGISTRY: "ghcr.io"

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v2

      - name: Docker Login
        uses: docker/login-action@v1.12.0
        with:
          registry: ${{ env.GITHUB_REGISTRY }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          logout: true

      - name: Build and push Docker images
        uses: docker/build-push-action@v2.8.0
        with:
          build-args: |
            ACCEPT_EULA="y"
            PYTHON3_VERSION="${{ env.PYTHON3_VERSION }}"

          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKERFILE_NAME }}
          tags: "${{ env.GITHUB_REGISTRY }}/${{ secrets.USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.TAGS }}"
          labels: |
            DateCreated=$(date +'%Y-%m-%d')

          push: "${{ env.GITHUB_REGISTRY }}/${{ secrets.USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.TAGS }}"
          github-token: ${{ GITHUB_TOKEN }}